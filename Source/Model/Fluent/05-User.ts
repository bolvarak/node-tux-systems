///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'use strict'; /// Strict Syntax //////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// Sequelize Dependencies ///////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

import {
	AfterCreate,
	AfterFind,
	AfterUpdate,
	BeforeCreate,
	BeforeUpdate,
	Column,
	DataType,
	ForeignKey,
	IsEmail,
	HasMany,
	HasOne,
	Length,
	Model,
	Table,
	BelongsTo
} from 'sequelize-typescript';

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import {Account} from './00-Account'; /// Account Model //////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import $crypto from '../../Library/Cryptography'; /// Cryptographic Library //////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
/// User Table Model Definition //////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

@Table({
	indexes: [
		{fields: ['account_id']},
		{fields: ['email_address']},
		{fields: ['is_active']},
		{fields: ['is_admin']},
		{fields: ['is_primary']},
		{fields: ['username'], unique: true}
	],
	tableName: 'user'
})
export class User extends Model<User> {

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Columns //////////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@Column({
		allowNull: false,
		field: 'account_id',
		type: DataType.UUID
	})
	accountId!: string;

	@Column({
		allowNull: false,
		field: 'email_address',
		type: DataType.STRING,
	})
	@IsEmail
	emailAddress!: string;

	@Column({
		allowNull: false,
		field: 'first_name',
		type: DataType.STRING(150)
	})
	@Length({
		max: 150
	})
	firstName!: string;

	@Column({
		allowNull: false,
		defaultValue: DataType.UUIDV4,
		field: 'id',
		primaryKey: true,
		type: DataType.UUID
	})
	id!: string;

	@Column({
		allowNull: false,
		defaultValue: true,
		field: 'is_active',
		type: DataType.BOOLEAN
	})
	isActive!: boolean;

	@Column({
		allowNull: true,
		defaultValue: false,
		field: 'is_admin',
		type: DataType.BOOLEAN
	})
	isAdmin!: boolean;

	@Column({
		allowNull: false,
		defaultValue: false,
		field: 'is_primary',
		type: DataType.BOOLEAN
	})
	isPrimary!: boolean;

	@Column({
		'allowNull': false,
		field: 'last_name',
		type: DataType.STRING(150)
	})
	@Length({
		max: 150
	})
	lastName!: string;

	@Column({
		allowNull: true,
		field: 'password',
		type: DataType.TEXT
	})
	password!: string;

	@Column({
		allowNull: false,
		field: 'username',
		type: DataType.STRING(125)
	})
	@Length({
		max: 125
	})
	username!: string;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Associations /////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@BelongsTo(() => Account)
	account!: Account;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Hooks ////////////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	@AfterCreate
	@AfterFind
	@AfterUpdate
	public static decryptPassword($instance: User): void {
		// Check for a hash
		if ($crypto.isHash($instance.password)) {
			// Decrypt the password
			$instance.password = $crypto.staticKeyDecrypt($instance.password);
		}
	}

	@BeforeCreate
	@BeforeUpdate
	public static encryptPassword($instance: User): void {
		// Check for a hash
		if (!$crypto.isHash($instance.password)) {
			// Encrypt the password
			$instance.password = $crypto.staticKeyEncrypt($instance.password);
		}
	}
}

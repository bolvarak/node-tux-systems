///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
'use strict'; /// Strict Syntax //////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import $config from './Configuration'; /// Configuration Settings ////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import $utility from './Utility'; /// Utility Module /////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import * as Bluebird from 'bluebird'; /// Bluebird Promises Module ///////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import { Sequelize } from 'sequelize-typescript'; /// Sequelize Module ///////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
import * as path from 'path'; /// Path Module ////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
export default class CommonDatabaseClass { /// CommonDatabase Class Definition ///////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Constants ////////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/**
	 * This constant contains a reference to the Sequlize Library
	 * @name CommonDatabaseClass.library
	 * @public
	 * @static
	 * @type {Sequelize}
	 */
	public static library = Sequelize;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Properties ///////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/**
	 * This property contains the database connection
	 * @name CommonDatabaseClass.connection
	 * @public
	 * @type {Sequelize}
	 */
	public connection: Sequelize;

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Constructor //////////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/**
	 * This method instantiates a new CommonDatabase class object
	 * @name CommonDatabaseClass.constructor()
	 * @returns {CommonDatabaseClass}
	 */
	constructor() {

		///////////////////////////////////////////////////////////////////////////////////////////////////////////////
		/// Connection Initialization ////////////////////////////////////////////////////////////////////////////////
		/////////////////////////////////////////////////////////////////////////////////////////////////////////////

		// Connect to the database
		this.connection = new Sequelize($config.db);

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	} /// End Constructor ////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	///////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	/// Public Methods ///////////////////////////////////////////////////////////////////////////////////////////////
	/////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	/**
	 * This method executes a SQL file stored on the filesystem
	 * @async
	 * @name CommonDatabase.executeSqlFile()
	 * @param {string} $file
	 * @param {sequelize.QueryOptions|undefined, optional} $options
	 * @public
	 * @returns {Promise<Bluebird<any>>}
	 */
	async executeSqlFile($file: string, $options?: any): Promise<Bluebird<any>> {
		// Check the file path
		if ($file.substr(0, 1) !== path.sep) {
			// Reset the file name
			$file = path.join(__dirname, '..', 'Data', 'Query', $file);
		}
		// Check for a file extension
		if ($file.substr(-4).toLowerCase() !== '.sql') {
			// Append the extension
			$file += '.sql';
		}
		// Read the SQL file
		let $sql = await $utility.fsReadFile($file, 'utf8');
		// Execute the query
		return await this.connection.query($sql.toString(), $options);
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
} /// End CommonDatabase Class Definition ////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
const CommonDatabase = new CommonDatabaseClass(); /// CommonDatabase Module Instantiation ////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
export { CommonDatabase }; /// CommonDatabase Module Export //////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
